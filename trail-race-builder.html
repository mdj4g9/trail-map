<!-- Updated HTML and JavaScript with PDF/CSV download + multi-month calendar navigation -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trail Race Plan Creator</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f7f7f7; margin: 0; padding: 20px; color: #2c3e50; }
    .container { max-width: 960px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { color: #2e8b57; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input[type="number"], input[type="date"] { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 30px; }
    .calendar-day { background: #eaf2f8; padding: 10px; border-radius: 5px; min-height: 100px; position: relative; font-size: 0.9em; }
    .calendar-day .icon { font-size: 1.2em; margin-right: 5px; }
    .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
    .controls button { padding: 8px 12px; margin-left: 10px; background-color: #2e8b57; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
    .controls button:hover { background-color: #276746; }
    button[type="submit"] { margin-top: 20px; padding: 10px 20px; background-color: #2e8b57; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
    button[type="submit"]:hover { background-color: #276746; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Trail Race Plan Creator</h1>

    <form id="plan-form">
      <label for="weeks">Number of Weeks</label>
      <select id="weeks">
        <option value="4">4</option>
        <option value="6">6</option>
        <option value="8">8</option>
        <option value="10" selected>10</option>
        <option value="12">12</option>
      </select>

      <label for="start-date">Plan Start Date</label>
      <input type="date" id="start-date" value="2025-03-10">

      <label for="current-mileage">Current Weekly Mileage</label>
      <input type="number" id="current-mileage" value="15" min="1" max="50">

      <label for="current-elevation">Current Weekly Elevation Gain (ft)</label>
      <input type="number" id="current-elevation" value="800" min="0" max="30000">

      <label for="longest-run">Current Longest Run (mi)</label>
      <input type="number" id="longest-run" value="6" min="1">

      <label for="zone2-pace">Zone 2 Pace</label>
      <select id="zone2-pace">
        <option>9:00</option>
        <option>9:30</option>
        <option selected>10:30</option>
        <option>11:00</option>
        <option>12:00</option>
      </select>

      <label for="toggle-hr-info">Show Heart Rate / Pace Info?</label>
      <select id="toggle-hr-info">
        <option>No</option>
        <option selected>Yes</option>
      </select>

      <button type="submit">Generate Plan</button>
    </form>

    <div class="controls">
      <div>
        <button onclick="downloadPlanAsCSV()">Download CSV</button>
        <button onclick="downloadPlanAsPDF()">Download PDF</button>
      </div>
      <div>
        <button onclick="prevMonth()">Previous</button>
        <button onclick="nextMonth()">Next</button>
      </div>
    </div>

    <div class="calendar-grid"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let currentMonthIndex = 0;
    let fullPlan = [];

    function downloadPlanAsCSV() {
      let csv = 'Date,Day,Type,Mileage,Elevation,HR Zone,Pace\n';
      fullPlan.forEach(week => {
        week.workouts.forEach(w => {
          csv += `${w.date},${w.day},${w.type},${w.mileage},${w.elevation},${w.heartRateZone},${w.pace}\n`;
        });
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'training_plan.csv';
      link.click();
    }

    function downloadPlanAsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      fullPlan.forEach(week => {
        doc.text(`Week ${week.week + 1}`, 10, y);
        y += 6;
        week.workouts.forEach(w => {
          doc.text(`${w.date} - ${w.day} - ${w.type} - ${w.mileage}mi - ${w.elevation}ft - HR: ${w.heartRateZone} - Pace: ${w.pace}`, 10, y);
          y += 6;
          if (y > 270) { doc.addPage(); y = 10; }
        });
        y += 4;
      });
      doc.save('training_plan.pdf');
    }

    function prevMonth() {
      if (currentMonthIndex > 0) {
        currentMonthIndex--;
        renderPlanToCalendar(fullPlan, true);
      }
    }

    function nextMonth() {
      if ((currentMonthIndex + 1) * 28 < fullPlan.flatMap(w => w.workouts).length) {
        currentMonthIndex++;
        renderPlanToCalendar(fullPlan, true);
      }
    }

    function renderPlanToCalendar(plan, showHR) {
      const calendar = document.querySelector('.calendar-grid');
      calendar.innerHTML = '';
      const icons = { easy: 'ðŸƒâ€â™‚ï¸', long: 'ðŸ”ï¸', threshold: 'ðŸ”¥', anaerobic: 'âš¡', rest: 'ðŸ’¤' };
      const allDays = plan.flatMap(w => w.workouts);
      const viewDays = allDays.slice(currentMonthIndex * 28, (currentMonthIndex + 1) * 28);
      viewDays.forEach(w => {
        const d = document.createElement('div');
        d.className = 'calendar-day';
        d.innerHTML = `<span class='icon'>${icons[w.type]}</span><strong>${w.type}:</strong> ${w.mileage}mi, ${w.elevation}ft<br><small>${w.date}</small>`;
        if (showHR) d.innerHTML += `<br><small>HR: ${w.heartRateZone}, Pace: ${w.pace}</small>`;
        calendar.appendChild(d);
      });
    }

    function handleFormSubmission(e) {
      if (e) e.preventDefault();
      const input = {
        weeks: parseInt(document.querySelector('#weeks').value),
        startDate: document.querySelector('#start-date').value,
        currentMileage: parseInt(document.querySelector('#current-mileage').value),
        currentElevation: parseInt(document.querySelector('#current-elevation').value),
        longestRun: parseInt(document.querySelector('#longest-run').value),
        goal: 'Finish',
        availableDays: ['Sunday', 'Tuesday', 'Wednesday', 'Friday', 'Saturday'],
        preferredLongRunDays: ['Saturday'],
        zone2Pace: document.querySelector('#zone2-pace').value,
        showHeartRateInfo: document.querySelector('#toggle-hr-info').value === 'Yes'
      };
      fullPlan = generateTrainingPlan(input);
      currentMonthIndex = 0;
      renderPlanToCalendar(fullPlan, input.showHeartRateInfo);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelector('#plan-form').addEventListener('submit', handleFormSubmission);
      document.querySelector('#toggle-hr-info').addEventListener('change', handleFormSubmission);
      handleFormSubmission();
    });
  </script>
</body>
</html>

